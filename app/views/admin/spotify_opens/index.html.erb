<div class="container mx-auto px-6 py-8">
  <div class="mb-8">
    <h1 class="text-4xl font-bold text-white mb-2">üéµ Spotify Opens Analytics</h1>
    <p class="text-gray-400">Track when users open playlists on Spotify</p>
  </div>

  <!-- Stats Grid -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-gradient-to-br from-green-900 to-green-800 rounded-xl p-6 border border-green-700 shadow-xl">
      <div class="text-green-200 text-sm font-semibold mb-2">Total Opens</div>
      <div class="text-4xl font-bold text-white"><%= @total_opens %></div>
      <div class="text-xs text-green-300 mt-2">All time</div>
    </div>
    
    <div class="bg-gradient-to-br from-blue-900 to-blue-800 rounded-xl p-6 border border-blue-700 shadow-xl">
      <div class="text-blue-200 text-sm font-semibold mb-2">Today</div>
      <div class="text-4xl font-bold text-white"><%= @opens_today %></div>
      <div class="text-xs text-blue-300 mt-2">Last 24 hours</div>
    </div>
    
    <div class="bg-gradient-to-br from-purple-900 to-purple-800 rounded-xl p-6 border border-purple-700 shadow-xl">
      <div class="text-purple-200 text-sm font-semibold mb-2">This Week</div>
      <div class="text-4xl font-bold text-white"><%= @opens_this_week %></div>
      <div class="text-xs text-purple-300 mt-2">Last 7 days</div>
    </div>
    
    <div class="bg-gradient-to-br from-yellow-900 to-yellow-800 rounded-xl p-6 border border-yellow-700 shadow-xl">
      <div class="text-yellow-200 text-sm font-semibold mb-2">Conversion</div>
      <% conversion = @total_opens > 0 && defined?(@total_visits) ? ((@total_opens.to_f / @total_visits) * 100).round(1) : 0 %>
      <div class="text-4xl font-bold text-white"><%= conversion %>%</div>
      <div class="text-xs text-yellow-300 mt-2">Opens / Visits</div>
    </div>
  </div>

  <!-- Opens by Location -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
      <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
        <span>üìç</span> Opens by Location
      </h2>
      <div class="space-y-2">
        <% @opens_by_location.sort_by { |_, count| -count }.each do |location, count| %>
          <div class="flex items-center justify-between bg-gray-900 rounded-lg p-3 border border-gray-700">
            <div class="flex-1">
              <div class="text-sm font-medium text-white capitalize"><%= location %></div>
            </div>
            <div class="text-xl font-bold text-green-400 ml-4"><%= count %></div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Most Opened Playlists -->
    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
      <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
        <span>üî•</span> Most Opened Playlists
      </h2>
      <div class="space-y-2">
        <% @most_opened_playlists.each_with_index do |playlist, index| %>
          <div class="flex items-center gap-3 bg-gray-900 rounded-lg p-3 border border-gray-700">
            <div class="text-yellow-400 font-bold text-sm w-8">#<%= index + 1 %></div>
            <div class="flex-1 min-w-0">
              <div class="text-white font-medium text-sm truncate"><%= playlist.title %></div>
            </div>
            <div class="text-green-400 font-bold text-lg"><%= playlist.opens_count %></div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Recent Opens Log -->
  <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
    <h2 class="text-2xl font-bold text-white mb-4">üìã Recent Spotify Opens</h2>
    
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead>
          <tr class="border-b border-gray-700">
            <th class="text-left py-3 px-4 text-gray-400 font-semibold text-sm">Time</th>
            <th class="text-left py-3 px-4 text-gray-400 font-semibold text-sm">Playlist</th>
            <th class="text-left py-3 px-4 text-gray-400 font-semibold text-sm">Location</th>
            <th class="text-left py-3 px-4 text-gray-400 font-semibold text-sm">Session</th>
            <th class="text-left py-3 px-4 text-gray-400 font-semibold text-sm">Device</th>
            <th class="text-left py-3 px-4 text-gray-400 font-semibold text-sm">IP</th>
          </tr>
        </thead>
        <tbody>
          <% @spotify_opens.each do |open| %>
            <tr class="border-b border-gray-700/50 hover:bg-gray-700/30">
              <td class="py-3 px-4 text-gray-300 text-sm whitespace-nowrap">
                <%= time_ago_in_words(open.created_at) %> ago
              </td>
              <td class="py-3 px-4 text-white text-sm max-w-xs truncate">
                <%= open.playlist.title %>
              </td>
              <td class="py-3 px-4 text-sm">
                <span class="px-2 py-1 rounded-full text-xs font-semibold
                  <%= case open.location
                      when 'featured' then 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/50'
                      when 'regular' then 'bg-blue-500/20 text-blue-400 border border-blue-500/50'
                      when 'category' then 'bg-purple-500/20 text-purple-400 border border-purple-500/50'
                      when 'search' then 'bg-green-500/20 text-green-400 border border-green-500/50'
                      when 'whats_new' then 'bg-pink-500/20 text-pink-400 border border-pink-500/50'
                      else 'bg-gray-500/20 text-gray-400 border border-gray-500/50'
                      end %>">
                  <%= open.location %>
                </span>
              </td>
              <td class="py-3 px-4 text-gray-400 text-xs font-mono truncate max-w-xs">
                <%= open.session_id&.truncate(12) || 'N/A' %>
              </td>
              <td class="py-3 px-4 text-gray-400 text-xs">
                <% if open.user_agent %>
                  <% agent = open.user_agent %>
                  <% if agent.match?(/mobile|android|iphone|ipad/i) %>
                    üì± Mobile
                  <% elsif agent.match?(/tablet/i) %>
                    üì± Tablet
                  <% else %>
                    üíª Desktop
                  <% end %>
                <% end %>
              </td>
              <td class="py-3 px-4 text-gray-500 text-xs font-mono">
                <%= open.ip_address&.truncate(15) || 'N/A' %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
    
    <!-- Pagination -->
    <div class="mt-6 flex justify-center">
      <%= paginate @spotify_opens, theme: 'twitter-bootstrap-4' %>
    </div>
  </div>
</div>

